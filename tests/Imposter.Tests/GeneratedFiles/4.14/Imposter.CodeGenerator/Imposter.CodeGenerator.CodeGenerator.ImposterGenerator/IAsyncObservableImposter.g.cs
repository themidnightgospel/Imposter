// <auto-generated />
#nullable enable
#pragma warning disable
using global::System;
using global::System.Linq;
using global::System.Collections.Generic;
using global::System.Threading.Tasks;
using global::System.Diagnostics;
using global::System.Runtime.CompilerServices;
using global::Imposter.Abstractions;
using global::System.Collections.Concurrent;
using global::Imposter.Tests.Features.OpenGenericImposter;

namespace Imposter.Tests.Features.OpenGenericImposter
{
    [global::System.CodeDom.Compiler.GeneratedCode("Imposter.CodeGenerator", "0.1.0.0")]
    public sealed class IAsyncObservableImposter<T> : global::Imposter.Abstractions.IHaveImposterInstance<global::Imposter.Tests.Features.OpenGenericImposter.IAsyncObservable<T>>
    {
        private readonly OnNextMethodImposter _onNextMethodImposter;
        private readonly OnNextMethodInvocationHistoryCollection _onNextMethodInvocationHistoryCollection = new OnNextMethodInvocationHistoryCollection();
        public IOnNextMethodImposterBuilder OnNext(global::Imposter.Abstractions.Arg<T> item)
        {
            return new OnNextMethodImposter.Builder(_onNextMethodImposter, _onNextMethodInvocationHistoryCollection, new OnNextArgumentsCriteria(item));
        }

        private readonly global::Imposter.Abstractions.ImposterMode _invocationBehavior;
        private ImposterTargetInstance _imposterInstance;
        global::Imposter.Tests.Features.OpenGenericImposter.IAsyncObservable<T> global::Imposter.Abstractions.IHaveImposterInstance<global::Imposter.Tests.Features.OpenGenericImposter.IAsyncObservable<T>>.Instance()
        {
            return _imposterInstance;
        }

        // void IAsyncObservable<T>.OnNext(T item)
        public delegate void OnNextDelegate(T item);
        // void IAsyncObservable<T>.OnNext(T item)
        public delegate void OnNextCallbackDelegate(T item);
        // void IAsyncObservable<T>.OnNext(T item)
        public delegate global::System.Exception OnNextExceptionGeneratorDelegate(T item);
        [global::System.CodeDom.Compiler.GeneratedCode("Imposter.CodeGenerator", "0.1.0.0")]
        public class OnNextArguments
        {
            public T item;
            internal OnNextArguments(T item)
            {
                this.item = item;
            }
        }

        // void IAsyncObservable<T>.OnNext(T item)
        [global::System.CodeDom.Compiler.GeneratedCode("Imposter.CodeGenerator", "0.1.0.0")]
        public class OnNextArgumentsCriteria
        {
            public global::Imposter.Abstractions.Arg<T> item { get; }

            public OnNextArgumentsCriteria(global::Imposter.Abstractions.Arg<T> item)
            {
                this.item = item;
            }

            public bool Matches(OnNextArguments arguments)
            {
                return item.Matches(arguments.item);
            }
        }

        [global::System.CodeDom.Compiler.GeneratedCode("Imposter.CodeGenerator", "0.1.0.0")]
        public interface IOnNextMethodInvocationHistory
        {
            bool Matches(OnNextArgumentsCriteria criteria);
        }

        [global::System.CodeDom.Compiler.GeneratedCode("Imposter.CodeGenerator", "0.1.0.0")]
        internal class OnNextMethodInvocationHistory : IOnNextMethodInvocationHistory
        {
            internal OnNextArguments Arguments;
            internal global::System.Exception? Exception;
            public OnNextMethodInvocationHistory(OnNextArguments Arguments, global::System.Exception? Exception)
            {
                this.Arguments = Arguments;
                this.Exception = Exception;
            }

            public bool Matches(OnNextArgumentsCriteria criteria)
            {
                return criteria.Matches(Arguments);
            }

            public override string ToString()
            {
                return "OnNext(" + global::System.String.Join(", ", new[] { "item: " + FormatValue(Arguments.item) }) + ")" + Exception == null ? "" : " threw " + FormatValue(Exception);
            }

            private static string FormatValue(object? value)
            {
                return "<" + value?.ToString() ?? "null" + ">";
            }
        }

        [global::System.CodeDom.Compiler.GeneratedCode("Imposter.CodeGenerator", "0.1.0.0")]
        internal class OnNextMethodInvocationHistoryCollection
        {
            private readonly global::System.Collections.Concurrent.ConcurrentStack<IOnNextMethodInvocationHistory> _invocationHistory = new global::System.Collections.Concurrent.ConcurrentStack<IOnNextMethodInvocationHistory>();
            internal void Add(IOnNextMethodInvocationHistory invocationHistory)
            {
                _invocationHistory.Push(invocationHistory);
            }

            internal int Count(OnNextArgumentsCriteria argumentsCriteria)
            {
                return _invocationHistory.Count(it => it.Matches(argumentsCriteria));
            }

            public override string ToString()
            {
                return string.Join(Environment.NewLine, _invocationHistory.Select(invocation => invocation.ToString()));
            }
        }

        [global::System.CodeDom.Compiler.GeneratedCode("Imposter.CodeGenerator", "0.1.0.0")]
        class OnNextMethodInvocationImposterGroup
        {
            internal static OnNextMethodInvocationImposterGroup Default = new OnNextMethodInvocationImposterGroup(new OnNextArgumentsCriteria(global::Imposter.Abstractions.Arg<T>.Any()));
            internal OnNextArgumentsCriteria ArgumentsCriteria { get; }

            private readonly global::System.Collections.Concurrent.ConcurrentQueue<MethodInvocationImposter> _invocationImposters = new global::System.Collections.Concurrent.ConcurrentQueue<MethodInvocationImposter>();
            private MethodInvocationImposter? _lastestInvocationImposter;
            public OnNextMethodInvocationImposterGroup(OnNextArgumentsCriteria argumentsCriteria)
            {
                ArgumentsCriteria = argumentsCriteria;
            }

            internal MethodInvocationImposter AddInvocationImposter()
            {
                MethodInvocationImposter invocationImposter = new MethodInvocationImposter();
                _invocationImposters.Enqueue(invocationImposter);
                return invocationImposter;
            }

            private MethodInvocationImposter? GetInvocationImposter()
            {
                if (_invocationImposters.TryDequeue(out var invocationImposter))
                {
                    if (!invocationImposter.IsEmpty)
                    {
                        _lastestInvocationImposter = invocationImposter;
                    }

                    return invocationImposter;
                }

                return _lastestInvocationImposter;
            }

            public void Invoke(global::Imposter.Abstractions.ImposterMode invocationBehavior, string methodDisplayName, T item)
            {
                var invocationImposter = GetInvocationImposter();
                if (invocationImposter == null)
                {
                    if (invocationBehavior == global::Imposter.Abstractions.ImposterMode.Explicit)
                    {
                        throw new global::Imposter.Abstractions.MissingImposterException(methodDisplayName);
                    }

                    invocationImposter = MethodInvocationImposter.Default;
                }

                invocationImposter.Invoke(invocationBehavior, methodDisplayName, item);
            }

            [global::System.CodeDom.Compiler.GeneratedCode("Imposter.CodeGenerator", "0.1.0.0")]
            internal class MethodInvocationImposter
            {
                internal static MethodInvocationImposter Default;
                static MethodInvocationImposter()
                {
                    Default = new MethodInvocationImposter();
                    Default._resultGenerator = DefaultResultGenerator;
                }

                private OnNextDelegate? _resultGenerator;
                private readonly global::System.Collections.Concurrent.ConcurrentQueue<OnNextCallbackDelegate> _callbacks = new global::System.Collections.Concurrent.ConcurrentQueue<OnNextCallbackDelegate>();
                internal bool IsEmpty => (_resultGenerator == null) && (_callbacks.Count == 0);

                public void Invoke(global::Imposter.Abstractions.ImposterMode invocationBehavior, string methodDisplayName, T item)
                {
                    if (_resultGenerator == null)
                    {
                        if (invocationBehavior == global::Imposter.Abstractions.ImposterMode.Explicit)
                        {
                            throw new global::Imposter.Abstractions.MissingImposterException(methodDisplayName);
                        }

                        _resultGenerator = DefaultResultGenerator;
                    }

                    _resultGenerator.Invoke(item);
                    foreach (var callback in _callbacks)
                    {
                        callback(item);
                    }
                }

                internal void Callback(OnNextCallbackDelegate callback)
                {
                    _callbacks.Enqueue(callback);
                }

                internal void Throws(OnNextExceptionGeneratorDelegate exceptionGenerator)
                {
                    _resultGenerator = (T item) =>
                    {
                        throw exceptionGenerator(item);
                    };
                }

                internal static void DefaultResultGenerator(T item)
                {
                }
            }
        }

        [global::System.CodeDom.Compiler.GeneratedCode("Imposter.CodeGenerator", "0.1.0.0")]
        public interface IOnNextMethodInvocationImposterGroupCallback
        {
            IOnNextMethodInvocationImposterGroupContinuation Callback(OnNextCallbackDelegate callback);
        }

        [global::System.CodeDom.Compiler.GeneratedCode("Imposter.CodeGenerator", "0.1.0.0")]
        public interface IOnNextMethodInvocationImposterGroupContinuation : IOnNextMethodInvocationImposterGroupCallback
        {
            IOnNextMethodInvocationImposterGroup Then();
        }

        [global::System.CodeDom.Compiler.GeneratedCode("Imposter.CodeGenerator", "0.1.0.0")]
        public interface IOnNextMethodInvocationImposterGroup : IOnNextMethodInvocationImposterGroupCallback
        {
            IOnNextMethodInvocationImposterGroupContinuation Throws<TException>()
                where TException : global::System.Exception, new();
            IOnNextMethodInvocationImposterGroupContinuation Throws(global::System.Exception exception);
            IOnNextMethodInvocationImposterGroupContinuation Throws(OnNextExceptionGeneratorDelegate exceptionGenerator);
        }

        [global::System.CodeDom.Compiler.GeneratedCode("Imposter.CodeGenerator", "0.1.0.0")]
        public interface OnNextInvocationVerifier
        {
            void Called(Count count);
        }

        [global::System.CodeDom.Compiler.GeneratedCode("Imposter.CodeGenerator", "0.1.0.0")]
        public interface IOnNextMethodImposterBuilder : IOnNextMethodInvocationImposterGroup, IOnNextMethodInvocationImposterGroupCallback, OnNextInvocationVerifier
        {
        }

        [global::System.CodeDom.Compiler.GeneratedCode("Imposter.CodeGenerator", "0.1.0.0")]
        internal class OnNextMethodImposter
        {
            private readonly global::System.Collections.Concurrent.ConcurrentStack<OnNextMethodInvocationImposterGroup> _invocationImposters = new global::System.Collections.Concurrent.ConcurrentStack<OnNextMethodInvocationImposterGroup>();
            private readonly OnNextMethodInvocationHistoryCollection _onNextMethodInvocationHistoryCollection;
            private readonly global::Imposter.Abstractions.ImposterMode _invocationBehavior;
            public OnNextMethodImposter(OnNextMethodInvocationHistoryCollection _onNextMethodInvocationHistoryCollection, global::Imposter.Abstractions.ImposterMode _invocationBehavior)
            {
                this._onNextMethodInvocationHistoryCollection = _onNextMethodInvocationHistoryCollection;
                this._invocationBehavior = _invocationBehavior;
            }

            public bool HasMatchingInvocationImposterGroup(OnNextArguments arguments)
            {
                return FindMatchingInvocationImposterGroup(arguments) != null;
            }

            private OnNextMethodInvocationImposterGroup? FindMatchingInvocationImposterGroup(OnNextArguments arguments)
            {
                foreach (var invocationImposterGroup in _invocationImposters)
                {
                    if (invocationImposterGroup.ArgumentsCriteria.Matches(arguments))
                        return invocationImposterGroup;
                }

                return null;
            }

            public void Invoke(T item)
            {
                var arguments = new OnNextArguments(item);
                var matchingInvocationImposterGroup = FindMatchingInvocationImposterGroup(arguments);
                if (matchingInvocationImposterGroup == default)
                {
                    if (_invocationBehavior == global::Imposter.Abstractions.ImposterMode.Explicit)
                    {
                        throw new global::Imposter.Abstractions.MissingImposterException("void IAsyncObservable<T>.OnNext(T item)");
                    }

                    matchingInvocationImposterGroup = OnNextMethodInvocationImposterGroup.Default;
                }

                try
                {
                    matchingInvocationImposterGroup.Invoke(_invocationBehavior, "void IAsyncObservable<T>.OnNext(T item)", item);
                    _onNextMethodInvocationHistoryCollection.Add(new OnNextMethodInvocationHistory(arguments, default));
                }
                catch (global::System.Exception ex)
                {
                    _onNextMethodInvocationHistoryCollection.Add(new OnNextMethodInvocationHistory(arguments, ex));
                    throw;
                }
            }

            [global::System.CodeDom.Compiler.GeneratedCode("Imposter.CodeGenerator", "0.1.0.0")]
            internal class Builder : IOnNextMethodImposterBuilder, IOnNextMethodInvocationImposterGroupContinuation
            {
                private readonly OnNextMethodImposter _imposter;
                private readonly OnNextMethodInvocationHistoryCollection _onNextMethodInvocationHistoryCollection;
                private readonly OnNextArgumentsCriteria _argumentsCriteria;
                private readonly OnNextMethodInvocationImposterGroup _invocationImposterGroup;
                private OnNextMethodInvocationImposterGroup.MethodInvocationImposter _currentInvocationImposter;
                public Builder(OnNextMethodImposter _imposter, OnNextMethodInvocationHistoryCollection _onNextMethodInvocationHistoryCollection, OnNextArgumentsCriteria _argumentsCriteria)
                {
                    this._imposter = _imposter;
                    this._onNextMethodInvocationHistoryCollection = _onNextMethodInvocationHistoryCollection;
                    this._argumentsCriteria = _argumentsCriteria;
                    this._invocationImposterGroup = new OnNextMethodInvocationImposterGroup(_argumentsCriteria);
                    _imposter._invocationImposters.Push(_invocationImposterGroup);
                    this._currentInvocationImposter = this._invocationImposterGroup.AddInvocationImposter();
                }

                IOnNextMethodInvocationImposterGroupContinuation IOnNextMethodInvocationImposterGroup.Throws<TException>()
                {
                    _currentInvocationImposter.Throws((T item) =>
                    {
                        throw new TException();
                    });
                    return this;
                }

                IOnNextMethodInvocationImposterGroupContinuation IOnNextMethodInvocationImposterGroup.Throws(global::System.Exception exception)
                {
                    _currentInvocationImposter.Throws((T item) =>
                    {
                        throw exception;
                    });
                    return this;
                }

                IOnNextMethodInvocationImposterGroupContinuation IOnNextMethodInvocationImposterGroup.Throws(OnNextExceptionGeneratorDelegate exceptionGenerator)
                {
                    _currentInvocationImposter.Throws((T item) =>
                    {
                        throw exceptionGenerator.Invoke(item);
                    });
                    return this;
                }

                IOnNextMethodInvocationImposterGroupContinuation IOnNextMethodInvocationImposterGroupCallback.Callback(OnNextCallbackDelegate callback)
                {
                    _currentInvocationImposter.Callback(callback);
                    return this;
                }

                IOnNextMethodInvocationImposterGroup IOnNextMethodInvocationImposterGroupContinuation.Then()
                {
                    this._currentInvocationImposter = _invocationImposterGroup.AddInvocationImposter();
                    return this;
                }

                void OnNextInvocationVerifier.Called(global::Imposter.Abstractions.Count count)
                {
                    var invocationCount = _onNextMethodInvocationHistoryCollection.Count(_argumentsCriteria);
                    if (!count.Matches(invocationCount))
                    {
                        throw new global::Imposter.Abstractions.VerificationFailedException(count, invocationCount, _onNextMethodInvocationHistoryCollection.ToString());
                    }
                }
            }
        }

        public IAsyncObservableImposter(global::Imposter.Abstractions.ImposterMode invocationBehavior = global::Imposter.Abstractions.ImposterMode.Implicit)
        {
            this._onNextMethodImposter = new OnNextMethodImposter(_onNextMethodInvocationHistoryCollection, invocationBehavior);
            this._imposterInstance = new ImposterTargetInstance(this);
            this._invocationBehavior = invocationBehavior;
        }

        [global::System.CodeDom.Compiler.GeneratedCode("Imposter.CodeGenerator", "0.1.0.0")]
        class ImposterTargetInstance : global::Imposter.Tests.Features.OpenGenericImposter.IAsyncObservable<T>
        {
            private readonly IAsyncObservableImposter<T> _imposter;
            public ImposterTargetInstance(IAsyncObservableImposter<T> _imposter)
            {
                this._imposter = _imposter;
            }

            public void OnNext(T item)
            {
                _imposter._onNextMethodImposter.Invoke(item);
            }
        }
    }
}
#nullable restore
#pragma warning restore
